<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >	

<mapper namespace="funfun.repository.MK_FundingReposi">
	
	<resultMap type="project" id="projectResult"/>
	<!-- int totCnt() 총 데이터 건수 -->
	<select id="projcnt" resultType="int" parameterType="projSch">
		SELECT COUNT(*)
		FROM (SELECT a.*, round(a.PRO_MONEY/a.PRO_TARGET*100) percent, CEIL(a.pro_finish_date - current_date) dday, b.maker_name, b.MAKER_PROFILE 
			FROM project a, MAKER b
			WHERE a.MAKER_CODE = b.MAKER_CODE AND PRO_CURR = '정상'
			<if test="cate_title!=null and cate_title!= ''">
				and cate_title like '%' || #{cate_title} ||'%'
			</if>)
		WHERE 1=1
		<if test="projectsch!=null and projectsch!=''">
			and (pro_title like '%'||#{projectsch}||'%'
			or pro_keyword like '%'||#{projectsch}||'%'
			or maker_name like '%'||#{projectsch}||'%')
		</if>
	</select>
	<!-- 프로젝트 리스트 -->
	<select id="projectList" resultMap="projectResult" parameterType="projSch">
		SELECT *
		FROM (SELECT rownum cnt, c.*
			FROM (SELECT a.*, round(a.PRO_MONEY/a.PRO_TARGET*100) percent, CEIL(a.pro_finish_date - current_date) dday, b.maker_name, b.MAKER_PROFILE  
				FROM project a, MAKER b
				WHERE a.MAKER_CODE = b.MAKER_CODE AND PRO_CURR = '정상'
			<if test="cate_title!=null and cate_title!= ''">
				and cate_title like '%' || #{cate_title} ||'%'
			</if>
			) c
			WHERE 1=1
		<if test="projectsch!=null and projectsch!=''">
			and (pro_title like '%'||#{projectsch}||'%'
			or pro_keyword like '%'||#{projectsch}||'%'
			or maker_name like '%'||#{projectsch}||'%')
		</if>
		<if test="sort=='recent'">
			ORDER BY PRO_START_DATE DESC
		</if>
		<if test="sort=='amount'">
			ORDER BY PRO_MONEY ASC
		</if>
		<if test="sort=='closing'">
			ORDER BY dday ASC
		</if>
		)
		WHERE cnt BETWEEN #{start} AND #{end}
	</select>
	<!-- 프로젝트 상세보기 -->
	<select id="detail" resultType="project" parameterType="int">
		SELECT a.*, round(a.PRO_MONEY/a.PRO_TARGET*100) percent, CEIL(a.pro_finish_date - current_date) dday, b.maker_name FROM project a, MAKER b
		WHERE a.MAKER_CODE = b.MAKER_CODE
		AND PRO_CODE = #{pro_code}
	</select>
	<!-- 프로젝트 옵션 -->
	<resultMap type="projectOpt" id="proOptResult"/>
	<select id="proOptList" resultMap="proOptResult" parameterType="int">
		SELECT * FROM PRO_OPTION
		WHERE PRO_CODE = #{pro_code}
	</select>
	<!-- 관심프로젝트 등록 -->
	<select id="ckfavor" resultType="int" parameterType="project">
		SELECT count(*)
		FROM FAVOR
		WHERE MEM_CODE = #{mem_code}
		AND PRO_CODE = #{pro_code}
	</select>
	<insert id="insFavor" parameterType="project">
		INSERT INTO FAVOR VALUES(#{mem_code}, #{pro_code})
	</insert>
	<!-- 프로젝트 신고 -->
	<insert id="insReport" parameterType="report">
		INSERT INTO REPORT VALUES (REPORT_SEQ.nextval, #{mem_code}, #{pro_code}, REPORT_DETAIL, REPORT_IMG, current_date)
	</insert>
	
	
</mapper>